{% extends "base.html" %}

{% block title %}모니터링 - 네이버 블로그 자동화{% endblock %}

{% block content %}
<div class="row mb-4" x-data="monitorDashboard()" x-init="init()">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-graph-up"></i>
                모니터링
            </h1>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" @click="checkRankings()" :disabled="checking">
                    <span x-show="!checking"><i class="bi bi-arrow-repeat me-1"></i>순위 체크</span>
                    <span x-show="checking"><span class="spinner-border spinner-border-sm me-1"></span>체크 중...</span>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-file-earmark-text me-1"></i>리포트
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" @click.prevent="generateReport('weekly')">주간 리포트</a></li>
                        <li><a class="dropdown-item" href="#" @click.prevent="generateReport('monthly')">월간 리포트</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 종합 통계 카드 -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="fs-2 fw-bold text-success" x-text="stats.published_count ?? '-'"></div>
                        <div class="text-muted small">발행 포스트</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="fs-2 fw-bold text-primary" x-text="stats.avg_rank ? stats.avg_rank + '위' : 'N/A'"></div>
                        <div class="text-muted small">평균 검색 순위</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="fs-2 fw-bold text-warning" x-text="stats.best_rank ? stats.best_rank + '위' : 'N/A'"></div>
                        <div class="text-muted small">최고 순위</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <div class="fs-2 fw-bold text-danger" x-text="stats.monthly_cost ? stats.monthly_cost + '원' : '0원'"></div>
                        <div class="text-muted small">이번 달 비용</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <!-- 최근 발행 포스트 -->
            <div class="col-md-7">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-send-check me-2"></i>최근 발행 포스트</h6>
                    </div>
                    <div class="card-body p-0">
                        <template x-if="stats.recent_posts && stats.recent_posts.length > 0">
                            <div class="list-group list-group-flush">
                                <template x-for="post in stats.recent_posts" :key="post.id">
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1 me-2">
                                                <div class="fw-semibold text-truncate" style="max-width:360px"
                                                     x-text="post.title"></div>
                                                <div class="d-flex gap-2 mt-1">
                                                    <span class="badge bg-info" x-text="post.keyword || '-'"></span>
                                                    <span class="badge" :class="post.seo_score >= 70 ? 'bg-success' : 'bg-warning'"
                                                          x-text="'SEO ' + (post.seo_score || 0) + '점'"></span>
                                                    <span class="badge"
                                                          :class="post.publish_status === 'success' ? 'bg-success' : 'bg-danger'"
                                                          x-text="post.publish_status === 'success' ? '발행됨' : '실패'"></span>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <small class="text-muted d-block" x-text="formatDate(post.published_at)"></small>
                                                <a x-show="post.blog_url" :href="post.blog_url" target="_blank"
                                                   class="btn btn-outline-primary btn-sm mt-1">
                                                    <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="!stats.recent_posts || stats.recent_posts.length === 0">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                                발행된 포스트가 없습니다
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- 순위 이력 -->
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>네이버 검색 순위</h6>
                    </div>
                    <div class="card-body p-0">
                        <template x-if="rankings.length > 0">
                            <div class="list-group list-group-flush" style="max-height:400px;overflow-y:auto">
                                <template x-for="r in rankings" :key="r.id">
                                    <div class="list-group-item py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <span class="badge bg-primary me-2"
                                                      x-text="r.naver_rank ? r.naver_rank + '위' : '순위 외'"></span>
                                                <small class="text-truncate" style="max-width:200px" x-text="r.kw || r.title"></small>
                                            </div>
                                            <small class="text-muted" x-text="formatDate(r.checked_at)"></small>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="rankings.length === 0">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-search fs-3 d-block mb-2"></i>
                                <p class="mb-2">순위 데이터가 없습니다</p>
                                <button class="btn btn-outline-primary btn-sm" @click="checkRankings()">
                                    지금 체크하기
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- 리포트 출력 -->
        <div class="mt-4" x-show="reportContent">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>
                        <span x-text="reportPeriod === 'weekly' ? '주간 리포트' : '월간 리포트'"></span>
                    </h6>
                    <button class="btn btn-sm btn-outline-secondary" @click="reportContent = null">닫기</button>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded" style="white-space:pre-wrap" x-text="reportContent"></pre>
                </div>
            </div>
        </div>

        <!-- 알림 메시지 -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100">
            <div x-show="toast.show" x-transition class="toast show"
                 :class="toast.type === 'success' ? 'bg-success text-white' : 'bg-danger text-white'">
                <div class="toast-body" x-text="toast.message"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function monitorDashboard() {
    return {
        stats: {},
        rankings: [],
        checking: false,
        reportContent: null,
        reportPeriod: 'weekly',
        toast: { show: false, message: '', type: 'success' },

        async init() {
            await this.loadStats();
            await this.loadRankings();
        },

        async loadStats() {
            try {
                const res = await fetch('/api/monitor/stats');
                this.stats = await res.json();
            } catch (e) { console.error(e); }
        },

        async loadRankings() {
            try {
                const res = await fetch('/api/monitor/rankings');
                this.rankings = await res.json();
            } catch (e) { console.error(e); }
        },

        async checkRankings() {
            this.checking = true;
            try {
                const res = await fetch('/api/monitor/check-rankings', { method: 'POST' });
                if (res.ok) {
                    this.showToast('순위 체크가 시작되었습니다. 잠시 후 새로고침하세요.', 'success');
                    setTimeout(async () => {
                        await this.loadStats();
                        await this.loadRankings();
                        this.checking = false;
                    }, 10000);
                }
            } catch (e) {
                this.showToast('오류: ' + e.message, 'error');
                this.checking = false;
            }
        },

        async generateReport(period) {
            this.reportPeriod = period;
            try {
                const res = await fetch(`/api/monitor/report?period=${period}`);
                const data = await res.json();
                this.reportContent = data.content;
            } catch (e) {
                this.showToast('리포트 생성 실패: ' + e.message, 'error');
            }
        },

        showToast(message, type = 'success') {
            this.toast = { show: true, message, type };
            setTimeout(() => { this.toast.show = false; }, 4000);
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('ko-KR', {
                month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });
        }
    }
}
</script>
{% endblock %}
